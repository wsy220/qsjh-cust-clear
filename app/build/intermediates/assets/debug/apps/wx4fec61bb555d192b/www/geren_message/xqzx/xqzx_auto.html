<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>柒拾客服</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/main.css" />
		<style>
			.mui-bar-nav~.mui-content {
				margin-top: 10px;
			}
			
			body,
			html {
				/*height: 100%;*/
			}
			
			.mui-content {
				margin-bottom: 50px;
			}
			
			.mui-slider-handle {
				padding: 2%;
			}
			
			.head-img {
				width: 40px;
				height: 40px;
				border-radius: 50%;
			}
			
			.mui-media-body {
				width: 70%;
				color: #666666;
				font-size: 14px;
				padding: 2%;
				margin-left: 13%;
				border: 1px solid #fff;
				background-color: #fff;
				border-bottom-left-radius: 10px;
				border-top-right-radius: 10px;
				border-bottom-right-radius: 10px;
			}
			
			.yh-answer {
				border-top-left-radius: 10px;
				border-bottom-right-radius: 0;
			}
			
			.answer-list {
				list-style: none;
				padding: 2% 0;
			}
			
			.question-list {
				list-style: none;
				padding: 2% 0;
				border-bottom: 1px solid #DDDDDD;
			}
			
			.question-list-click {
				list-style: none;
				padding: 2% 0;
				color: #45d0d5;
				border-bottom: 1px solid #DDDDDD;
			}
			
			.no-list-dot {
				list-style: none;
			}
			
			.click-question {
				color: #00C0FF;
			}
			
			.satisfaction {
				margin: 30px;
				background-size: 100%;
				background-repeat: no-repeat;
				background-image: url(../../images/kfbj.png);
				text-align: center;
			}
			
			.button-agree {
				padding-top: 60%;
				padding-bottom: 10%;
				text-align: center;
			}
			
			/*.agree-yes,
			.agree-no,*/
			/*.to-labour {
				color: #FFFFFF;
				border-color: #FFFFFF;
			}*/
			
			.agree-yes {
				padding: 10px 32%;
				background-color: #ffbc45;
			}
			
			.agree-no {
				padding: 10px 29%;
				background-color: #ffe0a7;
			}
			
			/*.to-labour {
				padding: 10px 15%;
				background-color: #ffbc45;
			}*/
			
			footer {
				position: fixed;
				width: 100%;
				height: 50px;
				min-height: 50px;
				border-top: solid 1px #bbb;
				left: 0px;
				bottom: 0px;
				overflow: hidden;
				padding: 0px 50px;
				background-color: #fafafa;
			}
			
			.footer-left {
				position: absolute;
				width: 85%;
				height: 50px;
				left: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 6px 0px 6px 14px;
			}
			
			.footer-right {
				position: absolute;
				width: 50px;
				height: 50px;
				right: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 5px;
				display: inline-block;
			}
			
			.footer-left [class*=input] {
				width: 100%;
				height: 100%;
				border-radius: 5px;
			}
			
			.footer-left .input-text {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				line-height: 18px !important;
				font-family: verdana !important;
				overflow: hidden;
			}
			
			.labour {
				position: fixed;
				bottom: 12%;
				right: 7%;
			}
			
			.to-labour {
				position: fixed;
				bottom: 18%;
				right: 22%;
			}
			
			.labour-ph {
				position: fixed;
				bottom: 10%;
				right: 24%;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">小柒客服</h1>

		</header>
		<div class="mui-content" id="content">

			<div class="mui-slider-handle" id="guideHelloDiv">
				<div class="mui-media-object mui-pull-left">
					<img class="head-img" src="../../images/xiao7.png">
				</div>
				<div class="mui-media-body" id="guideHello"></div>
			</div>

			<div id="guideDiv"></div>
			<!--<div class="mui-slider-handle">
				<div class="mui-media-object mui-pull-left">
					<img class="head-img" src="../../images/003.png">
				</div>
				<div class="mui-media-body">
					<ul class="">
						<li class="question-list-click">
							<div style="text-align: center;width: 100%;">
								<a id="lastPage" class="mui-icon mui-icon-back mui-pull-left" style="color: #DDDDDD;font-size: 21px;"></a>
								热点问题
								<a id="nextPage" class="mui-icon mui-icon-forward mui-pull-right" style="color: #45d0d5;font-size: 21px;"></a>
							</div>
						</li>
						<ul class="no-list-dot" id="ques1">
							<li class="question-list">1.1111111111111111111</li>
							<li class="question-list">2.11111111111111111</li>
							<li class="question-list">3.1111111</li>
							<li class="question-list">4.111111111111111111111</li>
							<li class="question-list">5.11111111111</li>
						</ul>
						<ul class="no-list-dot" id="ques2">
							<li class="question-list">1.2222222222222222</li>
							<li class="question-list">2.22222222222222222222222</li>
							<li class="question-list">3.22222222</li>
							<li class="question-list">4.2222222222222</li>
							<li class="question-list">5.222222222222222222222</li>
						</ul>
					</ul>
				</div>
			</div>-->

			<div id="answerDiv"></div>
			<!--<div class="mui-slider-handle">
				<div class="mui-media-object mui-pull-right">
					<img id="head-img-user" class="head-img" src="{{userPic}}">
				</div>
				<div class="mui-media-body yh-answer">Q:{{ques}}</div>
			</div>
			<div class="mui-slider-handle">
				<div class="mui-media-object mui-pull-left">
					<img class="head-img" src="../../images/xiao7.png">
				</div>
				<div class="mui-media-body">
					<ul class="">
						<li class="answer-list">Q:{{sub.title}}</li>
						<li data-id="{{sub._id}}" class="answer-list">
							<div style="display: inline-flex;">
								<div style="width: 10%;">A:</div>
								<div style="width: 90%;">
									<p>{{@sub.content}}</p>
								</div>
							</div>

						</li>
					</ul>
				</div>
			</div>-->

			<div class="labour" id="showLabour">
				<img src="../../images/xqkf/568.png" width="55px" />
			</div>
			<div class="to-labour"  style="display: none;">
				<img src="../../images/xqkf/kf.png" width="40px" />
			</div>
			<div class="labour-ph" style="display: none;">
				<img src="../../images/xqkf/call.png" width="25px" />
			</div>
			<!--<div class="satisfaction">
				<div class="button-agree" id="labour">
					<button class="to-labour">转人工服务</button>
				</div>
				<div class="button-agree mui-row" id="agree">
					<div class="mui-col-xs-6"><button class="agree-yes">满意</button></div>
					<div class="mui-col-xs-6"><button class="agree-no">不满意</button></div>
				</div>
			</div>-->

		</div>
		<footer id="footer">
			<div class="footer-left">
				<textarea id='msg-text' type="text" class='input-text'></textarea>
			</div>
			<label id="enterQuestion" class="footer-right"><p style="margin-top: 5px;">发送</p></label>
		</footer>
	</body>
	<script type="text/javascript" src="../../js/mui.min.js"></script>
	<script type="text/javascript" src="../../plugs/qs/qs.immersed.js"></script>
	<script type="text/javascript" src="../../js/app.js"></script>
	<script type="text/javascript" src="../../js/constants.js"></script>
	<script type="text/javascript" src="../../js/sharemethods.js"></script>
	<script type="text/javascript" src="../../js/xiangyingshi.js"></script>
	<script type="text/javascript" src="../../js/jquery-3.1.1.min.js"></script>
	<script type="text/javascript" src="../../js/jquery-labelauty.js"></script>

	<script type="text/javascript" src="../../plugs/moment/moment.min.js"></script>
	<script type="text/javascript" src="../../js/art/template-web.js"></script>
	<script type="text/javascript" src="../../js/qs/qs.art.extend.js"></script>
	<script type="text/javascript" src="../../js/qs/qs.template.js"></script>
	<script type="text/javascript" src="../../js/iscroll/iscroll-probe.js"></script>
	<script type="text/javascript" src="../../js/qs/qs.iscroll.js"></script>
	<!--<script type="text/javascript" src="../js/qs/qs.immersed.js" ></script>-->
	<script>
		$('.satisfaction').hide();
//		$("#labour").hide();
		$("#guideHelloDiv").hide();
		mui.init({
			swipeBack: true //启用右滑关闭功能
		});
		var userPic, img_user = null;

		mui.plusReady(function() {
			if(plus.navigator.isImmersedStatusbar()) { // 兼容immersed状态栏模式
				// 获取状态栏高度并根据业务需求处理，这里重新计算了子窗口的偏移位置
				topoffset = (Math.round(plus.navigator.getStatusbarHeight()) + 45) + 'px';
				document.querySelector("header").style.height = topoffset;
				document.querySelector("header").style.paddingTop = "20px";
				document.querySelector(".mui-bar-nav~.mui-content").style.paddingTop = topoffset;
			}
			// 加载完毕后关闭等待框，并展示页面
			var currentView = plus.webview.currentWebview();
			currentView.show('slide-in-right', 200);
			plus.nativeUI.closeWaiting();
			var id = localStorage.getItem("TOKENID");
			var sussess = function(data) {
				console.log("获取头像-----》" + JSON.stringify(data));
				//服务器返回响应，根据响应结果，分析是否登录成功；
				if(data.result == "success") {
					userPic = data.data.patientavatar;
					if(userPic != null && userPic != '' && (userPic.indexOf("client\\") == 0)) {
						localStorage.setItem('HEAD_PHOTO', userPic.split("client\\")[1]);
						img_user = serverAddress + "/" + userPic.split("client\\")[1];
					}
					if(userPic != null && userPic != '' && (userPic.indexOf("client\\") < 0)) {
						localStorage.setItem('HEAD_PHOTO', userPic);
						img_user = serverAddress + "/" + userPic;
					}
					if(userPic != null && userPic != '' && (userPic.indexOf("client/") == 0)) {
						localStorage.setItem('HEAD_PHOTO', userPic.split("client/")[1]);
						img_user = serverAddress + "/" + userPic.split("client/")[1];
					}
					var guideQuesSub;
					console.log("userPic:" + img_user);

					//获取前导页问候语
					var guideHelloUrl = serverAddress + "/api/appproblem/listhello";
					var fdtpatientsussess = function(data) {
						console.log("小七问候语————————————————》" + JSON.stringify(data.data));
						if(data.data == "" && data.data == [] && data.data == null) {
							$("#guideHello").html("系统正忙，请稍候再试");
							return false;
						}

						if(data.result == "success") {
							$("#guideHelloDiv").show();
							for(var i = 0; i < data.data.length; i++) {
								if(data.data[i].subCode == "zdwhy") {
									$("#guideHello").html(data.data[i].mainLabel);
								}
							}

						} else {
							mui.toast(data.msg);
						}
					};
					commonHttpUtils(guideHelloUrl, "get", {}, fdtpatientsussess, error);

					//获取前导问题
					var page = 1;
					var a = 0;
					var pageNum = null;
					var guideUrl = serverAddress + "/api/appproblem/listrecommend";
					var fdtpatientsussess = function(data) {
						console.log("前导问题—第一页———————————————》" + JSON.stringify(data));
						if(data.result == "success") {
							var tlData = {
								sub: data.data,
								userPic: img_user
							};
							guideQuesSub = data.data;
							pageNum = Math.floor(data.pages);
							$("#guideDiv").processTL(templateRegister.guide, tlData, 'append', function() {
								//								$("#lastPage").addClass("lastPage");
							});
						} else {
							mui.toast(data.msg);
						}
					};
					commonHttpUtils(guideUrl, "get", {
						page: 1,
						limit: 5
					}, fdtpatientsussess, error);
					//					alert("pageNum:"+pageNum);
					$('.mui-content').on('tap', '.lastPage', function(event) {
						page = --page;
						//						alert("向前"+page);
						$("#guideDiv").html("");
						var guideUrl = serverAddress + "/api/appproblem/listrecommend";
						var fdtpatientsussess = function(data) {
							console.log("前导问题—第" + page + "页———————————————》" + JSON.stringify(data));
							if(data.result == "success") {
								var tlData = {
									sub: data.data,
									userPic: img_user
								};
								guideQuesSub = data.data;
								$("#guideDiv").processTL(templateRegister.guide, tlData, 'append', function() {
									$(".mui-icon-back").css("color", "#40CCD2");
									if(page == 1) {
										$(".mui-icon-back").css("color", "#DDDDDD");
										$("#lastPage").removeClass("lastPage");
									}
									$(".mui-icon-forward").css("color", "#40CCD2");
								});
							} else {
								mui.toast(data.msg);
							}
						};
						commonHttpUtils(guideUrl, "get", {
							page: page,
							limit: 5
						}, fdtpatientsussess, error);
					});

					$('.mui-content').on('tap', '.nextPage', function(event) {
						a = 1;
						page = page + a;
						//						alert("向后"+page);
						$("#guideDiv").html("");
						var guideUrl = serverAddress + "/api/appproblem/listrecommend";
						var fdtpatientsussess = function(data) {
							console.log("前导问题—第" + page + "页———————————————》" + JSON.stringify(data));
							if(data.result == "success") {
								var tlData = {
									sub: data.data,
									userPic: img_user
								};
								guideQuesSub = data.data;
								$("#guideDiv").processTL(templateRegister.guide, tlData, 'append', function() {
									$(".mui-icon-forward").css("color", "#40CCD2");
									if(pageNum == page) {
										$(".mui-icon-forward").css("color", "#DDDDDD");
										$("#nextPage").removeClass("nextPage");
									}
									$(".mui-icon-back").css("color", "#40CCD2");
								});
							} else {
								mui.toast(data.msg);
							}
						};
						commonHttpUtils(guideUrl, "get", {
							page: page,
							limit: 5
						}, fdtpatientsussess, error);
					});

					//用户提问选择前导问题
					$('.mui-content').on('tap', '.question-list', function(event) {
						var id = $(this).attr("data-id");
						$(this).addClass("click-question")
						var questionMain = $(this).attr("data-con");
						//用户提问回答
						var answerUrl = serverAddress + "/api/appproblem/readproblemDetail/" + id;
						var sussess = function(data) {
							console.log("回答------》" + JSON.stringify(data));
							if(data.result == "success") {
								var anData = {
									sub: data.data,
									ques: questionMain,
									userPic: img_user
								}
								$("#answerDiv").processTL(templateRegister.answer, anData, 'append', function() {});
								$('.satisfaction').show();
								$('html,body').animate({
									scrollTop: $('#footer').offset().top
								}, 1000);

							} else {
								mui.toast(data.msg);
							}
						};
						commonHttpUtils(answerUrl, "get", {}, sussess, error);
					});

					//用户提问输入模糊搜索
					$('#footer').on('tap', '#enterQuestion', function(event) {
						var questionMain = $("#msg-text").val();
						if(!questionMain && questionMain == "") {
							mui.toast("请输入搜索关键字");
							return false;
						}
						//用户提问回答
						var answerSearchUrl = serverAddress + "/api/appproblem/showProblemDetailListPost";
						var sussess = function(data) {
							console.log(JSON.stringify(data));
							if(data.count == 0) {
								var anData = {
									sub: "你所提的问题，不在智能客服问题库中，请您转接人工客服。",
									noSearch:true,
									searchZero:true,
									ques: questionMain,
									userPic: img_user
								}
								$("#answerDiv").processTL(templateRegister.guide, anData, 'append', function() {});
								$('.satisfaction').show();
								$("#msg-text").val("");

							} else {
								if(data.result == "success") {
									var anData = {
										sub: data.data,
										noSearch:true,
										searchZero:false,
										ques: questionMain,
										userPic: img_user
									}
									$("#answerDiv").processTL(templateRegister.guide, anData, 'append', function() {});
									$('.satisfaction').show();
									$("#msg-text").val("");

								} else {
									mui.toast(data.msg);
								}
							}

						};
						commonHttpUtils(answerSearchUrl, "POST", {
							keyword: questionMain
						}, sussess, error);
						$('html,body').animate({
							scrollTop: $('#footer').offset().top
						}, 1000);
					});
				};

			};
			var url = serverAddress + "/api/patient/getmyinfo/" + id;
			commonHttpUtils(url, "get", {}, sussess, error, true);

//			//选择满意
//			$('.mui-content').on('tap', '.agree-yes', function(event) {
//				mui.back();
//			});
//
//			//选择不满意
//			$('.mui-content').on('tap', '.agree-no', function(event) {
//				$("#labour").show();
//				$("#agree").hide();
//
//			});

			mui(".mui-content").on("tap", ".labour", function() {
				$(".to-labour").show();
				$(".labour-ph").show();
				$("#showLabour").addClass("noshow")
			});
			mui(".mui-content").on("tap", ".noshow", function() {
				$(".to-labour").hide();
				$(".labour-ph").hide();
				$("#showLabour").removeClass("noshow")
			})
			
			mui(".mui-content").on("tap", ".to-labour", function() {
				var dataId = "admin";
				var name = "客服人员";
				console.log("聊天id=" + dataId);
				mui.openWindow({
					url: '../../familydoctor/im-chat.html',
					id: 'im-chat.html',
					show: {
						autoShow: false, //页面loaded事件发生后自动显示，默认为true
						event: 'loaded' //页面显示时机，默认为titleUpdate事件时显示
					},
					waiting: {
						autoShow: true //自动显示等待框，默认为true
					},
					extras: {
						TO_ACCOUNT: dataId,
						TO_NAME: name
					}
				});
			});
			mui(".mui-content").on("tap", ".labour-ph", function() {
				var btnArray = ['拨打', '取消'];
				var phone = "400 178 0800";
				mui.confirm('是否拨打'+phone+' 电话 ？', '提示', btnArray, function(e) {
					if(e.index == 0) {
						plus.device.dial(phone, true);
					};

				})
			});

		});
	</script>

</html>